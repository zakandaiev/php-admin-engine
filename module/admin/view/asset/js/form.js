"use strict";const sleep=t=>new Promise((e=>setTimeout(e,t)));async function fetchWithTimeout(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:15e3;const i=new AbortController,a=setTimeout((()=>i.abort()),s),o=await fetch(t,{...e,signal:i.signal});return clearTimeout(a),o}class Form{constructor(t){var e,s;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.node=t,this.submit=t.querySelector('[type="submit"]'),this.options=i,this.node.hasAttribute("data-native")||!this.submit)return!1;this.action=this.node.action,this.method=this.node.method||"POST","get"===this.method.toLowerCase()&&(this.method="POST"),this.data_confirm=this.node.getAttribute("data-confirm"),this.data_reset=!!this.node.hasAttribute("data-reset"),this.data_redirect=this.node.getAttribute("data-redirect"),this.data_message=this.node.getAttribute("data-message"),this.toast=console.log,"undefined"!=typeof toast&&(this.toast=toast),this.confirmation=confirm,"undefined"!=typeof confirmation&&(this.confirmation=confirmation),this.api={delay_ms:(null===(e=this.options)||void 0===e||null===(e=e.api)||void 0===e?void 0:e.delay_ms)||1e3,timeout_ms:(null===(s=this.options)||void 0===s||null===(s=s.api)||void 0===s?void 0:s.timeout_ms)||15e3},this.action&&this.initialize()}initialize(){this.initValidation(),this.insertLoader(),this.listenSubmit()}initValidation(){if(!this.node.hasAttribute("data-validate"))return!1;this.submit.addEventListener("click",(()=>{this.node.querySelectorAll(":invalid").forEach((t=>{t.classList.remove("valid"),t.classList.add("invalid")})),this.node.querySelectorAll(":valid").forEach((t=>{t.classList.remove("invalid"),t.classList.add("valid")}))})),this.node.querySelectorAll("input, textarea, select").forEach((t=>{["input","change"].forEach((e=>{t.addEventListener(e,(()=>{t.validity.valid?(t.classList.remove("invalid"),t.classList.add("valid")):(t.classList.remove("valid"),t.classList.add("invalid"))}))}))}))}insertLoader(){var t;const e=null===(t=this.options)||void 0===t||null===(t=t.theme)||void 0===t?void 0:t.loader;return!!e&&(this.node.insertAdjacentHTML("beforeend",e),!0)}listenSubmit(){this.node.addEventListener("submit",(async t=>{t.preventDefault();if(!await this.checkConfirmation())return!1;this.disableForm();const e=await this.doRequest();"success"===e.status?(this.successRedirect(e),this.successResetForm(),this.toast(e.status,this.data_message||e.message)):this.toast(e.status,e.message),this.enableForm()}))}async doRequest(){const t=performance.now(),e={method:this.method,body:this.getFormData()};let s={code:null,status:null,message:null,data:null};try{var i;const t=await fetchWithTimeout(this.action,e,this.api.timeout_ms),a=null!==(i=await t.json())&&void 0!==i?i:{};s.code=t.status,s.status=a.status,s.message=a.message,s.data=a.data}catch(t){s.status="error",s.message=t}const a=performance.now()-t;var o;return a<this.api.delay_ms&&await(o=this.api.delay_ms-a,new Promise((t=>setTimeout(t,o)))),s}async checkConfirmation(){if(!this.data_confirm)return!0;let t=!0;return t=this.confirmation===confirm?confirm(this.data_confirm):await this.confirmation(this.data_confirm),t}getFormData(){var t;let e=new FormData(this.node);return null!==(t=this.options)&&void 0!==t&&t.csrf&&e.set(this.options.csrf.key,this.options.csrf.token),this.formatDates(e),e}formatDates(t){const e=(t,e)=>{const s=new Date(e.valueOf());switch(s.setMinutes(s.getMinutes()-s.getTimezoneOffset()),t){case"date":return s.toJSON().slice(0,10);case"datetime":return s.toJSON().slice(0,19).replace("T"," ");case"month":return s.toJSON().slice(0,7)}};for(const s of t.entries()){const i=s[0],a=this.node.querySelector(`[name="${i}"]`);if(a&&a.hasAttribute("data-picker")&&a.instance&&a.instance.selectedDates){const s=a.getAttribute("data-picker");if(!["date","datetime","month"].includes(s))return!1;a.hasAttribute("data-multiple")||a.hasAttribute("data-range")?(t.delete(i),a.instance.selectedDates.forEach((a=>t.append(i,e(s,a))))):t.set(i,a.value.length&&a.instance.selectedDates.length?e(s,a.instance.selectedDates[0]):[])}}}disableForm(){return this.node.setAttribute("disabled","disabled"),this.node.classList.add("submit"),this.node.querySelector('[type="submit"]').disabled=!0,!0}enableForm(){return this.node.removeAttribute("disabled","disabled"),this.node.classList.remove("submit"),this.node.querySelector('[type="submit"]').disabled=!1,!0}successRedirect(t){return this.data_redirect&&("this"===this.data_redirect?document.location.reload():window.location.href=decodeURI(this.data_redirect).replaceAll(/({\w+})/g,null==t?void 0:t.data)),!1}successResetForm(){return!!this.data_reset&&(this.node.reset(),!0)}}document.addEventListener("DOMContentLoaded",(()=>{document.querySelectorAll("form").forEach((t=>{new Form(t,ENGINE)}))}));