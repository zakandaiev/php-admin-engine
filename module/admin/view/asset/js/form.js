"use strict";const sleep=t=>new Promise((e=>setTimeout(e,t)));async function fetchWithTimeout(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:15e3;const s=new AbortController,a=setTimeout((()=>s.abort()),i),n=await fetch(t,{...e,signal:s.signal});return clearTimeout(a),n}class Form{constructor(t){var e,i;let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.node=t,this.options=s,this.submit=t.querySelector('[type="submit"]'),this.submit||(this.submit=document.createElement("button"),this.submit.classList.add("hidden"),this.node.appendChild(this.submit)),this.data_submit_native=!!this.node.hasAttribute("data-submit-native"),this.data_submit_onchange=!!this.node.hasAttribute("data-submit-onchange"),this.data_unset_null=!!this.node.hasAttribute("data-unset-null"),this.node.hasAttribute("data-native"))return!1;this.action=this.node.action,this.method=this.node.method||"POST","get"===this.method.toLowerCase()&&(this.method="POST"),this.data_confirm=this.node.getAttribute("data-confirm"),this.data_reset=!!this.node.hasAttribute("data-reset"),this.data_redirect=this.node.getAttribute("data-redirect"),this.data_message=this.node.getAttribute("data-message"),this.toast=console.log,"undefined"!=typeof toast&&(this.toast=toast),this.confirmation=confirm,"undefined"!=typeof confirmation&&(this.confirmation=confirmation),this.api={delay_ms:(null===(e=this.options)||void 0===e||null===(e=e.api)||void 0===e?void 0:e.delay_ms)||1e3,timeout_ms:(null===(i=this.options)||void 0===i||null===(i=i.api)||void 0===i?void 0:i.timeout_ms)||15e3},this.action&&this.initialize()}initialize(){this.initValidation(),this.insertLoader(),this.initSubmit(),this.listenSubmit()}initValidation(){if(!this.node.hasAttribute("data-validate"))return!1;this.submit.addEventListener("click",(()=>{this.node.querySelectorAll(":invalid").forEach((t=>{t.classList.remove("valid"),t.classList.add("invalid")})),this.node.querySelectorAll(":valid").forEach((t=>{t.classList.remove("invalid"),t.classList.add("valid")}))})),this.node.querySelectorAll("input, textarea, select").forEach((t=>{["input","change"].forEach((e=>{t.addEventListener(e,(()=>{t.validity.valid?(t.classList.remove("invalid"),t.classList.add("valid")):(t.classList.remove("valid"),t.classList.add("invalid"))}))}))}))}insertLoader(){var t;const e=null===(t=this.options)||void 0===t||null===(t=t.theme)||void 0===t?void 0:t.loader;return!!e&&(this.node.insertAdjacentHTML("beforeend",e),!0)}initSubmit(){this.data_submit_onchange&&this.node.querySelectorAll("[name]").forEach((t=>{t.onchange=()=>{this.node.requestSubmit(this.submit)}}))}listenSubmit(){this.node.addEventListener("submit",(async t=>{if(this.data_submit_native)return this.node.querySelectorAll("[name]").forEach((t=>{if(t.hasAttribute("data-picker")&&t.instance&&t.instance.selectedDates){const e=t.getAttribute("data-picker");if(!["date","datetime","month"].includes(e))return!1;t.hasAttribute("data-multiple")||t.hasAttribute("data-range")?t.value=t.instance.selectedDates.map((t=>this.getFormattedDate(e,t))).join(" - "):t.value=t.value.length&&t.instance.selectedDates.length?this.getFormattedDate(e,t.instance.selectedDates[0]):""}this.data_unset_null&&!t.value.length&&t.setAttribute("disabled",!0)})),!1;t.preventDefault();if(!await this.checkConfirmation())return!1;this.disableForm();const e=await this.doRequest();"success"===e.status?(this.successRedirect(e),this.successResetForm(),this.toast(e.status,this.data_message||e.message)):this.toast(e.status,e.message),this.enableForm()}))}async doRequest(){const t=performance.now(),e={method:this.method,body:this.getFormData()};let i={code:null,status:null,message:null,data:null};try{var s;const t=await fetchWithTimeout(this.action,e,this.api.timeout_ms),a=null!==(s=await t.json())&&void 0!==s?s:{};i.code=t.status,i.status=a.status,i.message=a.message,i.data=a.data}catch(t){i.status="error",i.message=t}const a=performance.now()-t;var n;return a<this.api.delay_ms&&await(n=this.api.delay_ms-a,new Promise((t=>setTimeout(t,n)))),i}async checkConfirmation(){if(!this.data_confirm)return!0;let t=!0;return t=this.confirmation===confirm?confirm(this.data_confirm):await this.confirmation(this.data_confirm),t}getFormData(){var t;let e=new FormData(this.node);return null!==(t=this.options)&&void 0!==t&&t.csrf&&e.set(this.options.csrf.key,this.options.csrf.token),this.formatDates(e),this.data_unset_null&&this.unsetNullFormData(e),e}formatDates(t){for(const e of t.entries()){const i=e[0],s=this.node.querySelector(`[name="${i}"]`);if(s&&s.hasAttribute("data-picker")&&s.instance&&s.instance.selectedDates){const e=s.getAttribute("data-picker");if(!["date","datetime","month"].includes(e))return!1;s.hasAttribute("data-multiple")||s.hasAttribute("data-range")?(t.delete(i),s.instance.selectedDates.forEach((s=>t.append(i,this.getFormattedDate(e,s))))):t.set(i,s.value.length&&s.instance.selectedDates.length?this.getFormattedDate(e,s.instance.selectedDates[0]):"")}}}unsetNullFormData(t){for(const e of t.entries()){const i=e[0];e[1].length||t.delete(i)}}getFormattedDate(t,e){const i=new Date(e.valueOf());switch(i.setMinutes(i.getMinutes()-i.getTimezoneOffset()),t){case"date":return i.toJSON().slice(0,10);case"datetime":return i.toJSON().slice(0,19).replace("T"," ");case"month":return i.toJSON().slice(0,7)}return!1}disableForm(){return this.node.setAttribute("disabled","disabled"),this.node.classList.add("submit"),this.submit.disabled=!0,!0}enableForm(){return this.node.removeAttribute("disabled","disabled"),this.node.classList.remove("submit"),this.submit.disabled=!1,!0}successRedirect(t){return this.data_redirect&&("this"===this.data_redirect?document.location.reload():window.location.href=decodeURI(this.data_redirect).replaceAll(/({\w+})/g,null==t?void 0:t.data)),!1}successResetForm(){return!!this.data_reset&&(this.node.reset(),!0)}}document.addEventListener("DOMContentLoaded",(()=>{document.querySelectorAll("form").forEach((t=>{new Form(t,ENGINE)}))}));