"use strict";const sleep=t=>new Promise((e=>setTimeout(e,t)));async function fetchWithTimeout(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:15e3;const s=new AbortController,a=setTimeout((()=>s.abort()),i),o=await fetch(t,{...e,signal:s.signal});return clearTimeout(a),o}class Form{constructor(t){var e,i;let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.node=t,this.submit=t.querySelector('[type="submit"]'),this.options=s,this.node.hasAttribute("data-native")||!this.submit)return!1;this.action=this.node.action,this.method=this.node.method||"POST","get"===this.method.toLowerCase()&&(this.method="POST"),this.data_confirm=this.node.getAttribute("data-confirm"),this.data_reset=!!this.node.hasAttribute("data-reset"),this.data_redirect=this.node.getAttribute("data-redirect"),this.data_message=this.node.getAttribute("data-message"),this.toast=console.log,"undefined"!=typeof toast&&(this.toast=toast),this.confirmation=confirm,"undefined"!=typeof confirmation&&(this.confirmation=confirmation),this.api={delay_ms:(null===(e=this.options)||void 0===e||null===(e=e.api)||void 0===e?void 0:e.delay_ms)||1e3,timeout_ms:(null===(i=this.options)||void 0===i||null===(i=i.api)||void 0===i?void 0:i.timeout_ms)||15e3},this.action&&this.initialize()}initialize(){this.initValidation(),this.insertLoader(),this.listenSubmit()}initValidation(){if(!this.node.hasAttribute("data-validate"))return!1;this.submit.addEventListener("click",(()=>{this.node.querySelectorAll(":invalid").forEach((t=>{t.classList.remove("valid"),t.classList.add("invalid")})),this.node.querySelectorAll(":valid").forEach((t=>{t.classList.remove("invalid"),t.classList.add("valid")}))})),this.node.querySelectorAll("input, textarea, select").forEach((t=>{["input","change"].forEach((e=>{t.addEventListener(e,(()=>{t.validity.valid?(t.classList.remove("invalid"),t.classList.add("valid")):(t.classList.remove("valid"),t.classList.add("invalid"))}))}))}))}insertLoader(){var t;const e=null===(t=this.options)||void 0===t||null===(t=t.theme)||void 0===t?void 0:t.loader;return!!e&&(this.node.insertAdjacentHTML("beforeend",e),!0)}listenSubmit(){this.node.addEventListener("submit",(async t=>{t.preventDefault();if(!await this.checkConfirmation())return!1;this.disableForm();const e=await this.doRequest();"success"===e.status?(this.successRedirect(e),this.successResetForm(),this.toast(e.status,this.data_message||e.message)):this.toast(e.status,e.message),this.enableForm()}))}async doRequest(){const t=performance.now(),e={method:this.method,body:this.getFormData()};let i={code:null,status:null,message:null,data:null};try{var s;const t=await fetchWithTimeout(this.action,e,this.api.timeout_ms),a=null!==(s=await t.json())&&void 0!==s?s:{};i.code=t.status,i.status=a.status,i.message=a.message,i.data=a.data}catch(t){i.status="error",i.message=t}const a=performance.now()-t;var o;return a<this.api.delay_ms&&await(o=this.api.delay_ms-a,new Promise((t=>setTimeout(t,o)))),i}async checkConfirmation(){if(!this.data_confirm)return!0;let t=!0;return t=this.confirmation===confirm?confirm(this.data_confirm):await this.confirmation(this.data_confirm),t}getFormData(){var t;let e=new FormData(this.node);return null!==(t=this.options)&&void 0!==t&&t.csrf&&e.set(this.options.csrf.key,this.options.csrf.token),e}disableForm(){return this.node.setAttribute("disabled","disabled"),this.node.classList.add("submit"),this.node.querySelector('[type="submit"]').disabled=!0,!0}enableForm(){return this.node.removeAttribute("disabled","disabled"),this.node.classList.remove("submit"),this.node.querySelector('[type="submit"]').disabled=!1,!0}successRedirect(t){return this.data_redirect&&("this"===this.data_redirect?document.location.reload():window.location.href=decodeURI(this.data_redirect).replaceAll(/({\w+})/g,null==t?void 0:t.data)),!1}successResetForm(){return!!this.data_reset&&(this.node.reset(),!0)}}document.addEventListener("DOMContentLoaded",(()=>{document.querySelectorAll("form").forEach((t=>{new Form(t,ENGINE)}))}));